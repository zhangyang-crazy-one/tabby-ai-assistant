import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';
import { ChatMessage } from '../../types/ai.types';
import { LoggerService } from '../core/logger.service';

export interface SavedSession {
    sessionId: string;
    title: string;
    messages: ChatMessage[];
    createdAt: Date;
    updatedAt: Date;
    messageCount: number;
}

const STORAGE_KEY = 'tabby-ai-assistant-chat-history';
const MAX_SESSIONS = 50;
const MAX_MESSAGES_PER_SESSION = 1000;

/**
 * 聊天历史服务
 * 持久化存储和管理聊天会话历史
 */
@Injectable({
    providedIn: 'root'
})
export class ChatHistoryService {
    private sessionsSubject = new BehaviorSubject<SavedSession[]>([]);
    public sessions$ = this.sessionsSubject.asObservable();

    constructor(private logger: LoggerService) {
        this.loadSessions();
    }

    /**
     * 保存会话
     */
    saveSession(sessionId: string, messages: ChatMessage[], title?: string): void {
        try {
            const sessions = this.sessionsSubject.value;
            const existingIndex = sessions.findIndex(s => s.sessionId === sessionId);

            const sessionTitle = title || this.generateSessionTitle(messages);
            const now = new Date();

            const session: SavedSession = {
                sessionId,
                title: sessionTitle,
                messages: this.trimMessages(messages),
                createdAt: existingIndex >= 0 ? sessions[existingIndex].createdAt : now,
                updatedAt: now,
                messageCount: messages.length
            };

            if (existingIndex >= 0) {
                sessions[existingIndex] = session;
            } else {
                sessions.unshift(session);
            }

            // 限制会话数量
            const trimmedSessions = sessions.slice(0, MAX_SESSIONS);
            this.sessionsSubject.next(trimmedSessions);
            this.saveToStorage(trimmedSessions);

            this.logger.info('Session saved', { sessionId, title: sessionTitle });

        } catch (error) {
            this.logger.error('Failed to save session', { error, sessionId });
            throw error;
        }
    }

    /**
     * 加载会话
     */
    loadSession(sessionId: string): SavedSession | undefined {
        const sessions = this.sessionsSubject.value;
        return sessions.find(s => s.sessionId === sessionId);
    }

    /**
     * 删除会话
     */
    deleteSession(sessionId: string): void {
        const sessions = this.sessionsSubject.value;
        const filteredSessions = sessions.filter(s => s.sessionId !== sessionId);
        this.sessionsSubject.next(filteredSessions);
        this.saveToStorage(filteredSessions);
        this.logger.info('Session deleted', { sessionId });
    }

    /**
     * 清空所有历史
     */
    clearAllHistory(): void {
        this.sessionsSubject.next([]);
        this.saveToStorage([]);
        this.logger.info('All chat history cleared');
    }

    /**
     * 搜索会话
     */
    searchSessions(query: string): SavedSession[] {
        const sessions = this.sessionsSubject.value;
        const lowercaseQuery = query.toLowerCase();

        return sessions.filter(session =>
            session.title.toLowerCase().includes(lowercaseQuery) ||
            session.messages.some(msg =>
                msg.content.toLowerCase().includes(lowercaseQuery)
            )
        );
    }

    /**
     * 获取最近的会话
     */
    getRecentSessions(count: number = 10): SavedSession[] {
        const sessions = this.sessionsSubject.value;
        return sessions.slice(0, count);
    }

    /**
     * 获取会话统计
     */
    getStatistics(): {
        totalSessions: number;
        totalMessages: number;
        averageMessagesPerSession: number;
        oldestSession?: Date;
        newestSession?: Date;
    } {
        const sessions = this.sessionsSubject.value;
        const totalSessions = sessions.length;
        const totalMessages = sessions.reduce((sum, s) => sum + s.messageCount, 0);
        const averageMessagesPerSession = totalSessions > 0 ? totalMessages / totalSessions : 0;

        const dates = sessions.map(s => s.createdAt.getTime());
        const oldestSession = dates.length > 0 ? new Date(Math.min(...dates)) : undefined;
        const newestSession = dates.length > 0 ? new Date(Math.max(...dates)) : undefined;

        return {
            totalSessions,
            totalMessages,
            averageMessagesPerSession: Math.round(averageMessagesPerSession * 100) / 100,
            oldestSession,
            newestSession
        };
    }

    /**
     * 导出所有历史
     */
    exportAllHistory(): string {
        const sessions = this.sessionsSubject.value;
        const exportData = {
            exportDate: new Date().toISOString(),
            version: '1.0',
            sessions
        };
        return JSON.stringify(exportData, null, 2);
    }

    /**
     * 导入历史
     */
    importHistory(data: string): void {
        try {
            const importData = JSON.parse(data);

            if (!importData.sessions || !Array.isArray(importData.sessions)) {
                throw new Error('Invalid history format');
            }

            const sessions = importData.sessions.map((s: any) => ({
                ...s,
                createdAt: new Date(s.createdAt),
                updatedAt: new Date(s.updatedAt)
            }));

            this.sessionsSubject.next(sessions);
            this.saveToStorage(sessions);

            this.logger.info('History imported', {
                sessionCount: sessions.length
            });

        } catch (error) {
            this.logger.error('Failed to import history', error);
            throw new Error('Invalid history file format');
        }
    }

    private loadSessions(): void {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const sessions = JSON.parse(stored).map((s: any) => ({
                    ...s,
                    createdAt: new Date(s.createdAt),
                    updatedAt: new Date(s.updatedAt)
                }));
                this.sessionsSubject.next(sessions);
                this.logger.info('Loaded sessions from storage', { count: sessions.length });
            }
        } catch (error) {
            this.logger.error('Failed to load sessions from storage', error);
            this.sessionsSubject.next([]);
        }
    }

    private saveToStorage(sessions: SavedSession[]): void {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
        } catch (error) {
            this.logger.error('Failed to save sessions to storage', error);
        }
    }

    private generateSessionTitle(messages: ChatMessage[]): string {
        const firstUserMessage = messages.find(m => m.role === 'user');
        if (!firstUserMessage) {
            return `会话 ${new Date().toLocaleString()}`;
        }

        const content = firstUserMessage.content;
        return content.length > 50 ? content.substring(0, 50) + '...' : content;
    }

    private trimMessages(messages: ChatMessage[]): ChatMessage[] {
        if (messages.length <= MAX_MESSAGES_PER_SESSION) {
            return messages;
        }

        // 保留最近的messages
        return messages.slice(-MAX_MESSAGES_PER_SESSION);
    }
}
