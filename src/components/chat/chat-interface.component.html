<div class="ai-chat-interface">
    <!-- Â§¥ÈÉ® -->
    <div class="ai-chat-header">
        <div class="header-left">
            <h2 class="ai-title">
                <i class="fa fa-comments"></i>
                {{ t.chatInterface.title }}
            </h2>
            <span class="provider-badge">
                <i class="fa fa-cloud"></i>
                {{ currentProvider }}
            </span>
        </div>
        <div class="header-actions">
            <button class="btn-icon" (click)="switchProvider()" [title]="t.chatInterface.switchProvider">
                <i class="fa fa-exchange"></i>
            </button>
            <button class="btn-icon" (click)="exportChat()" [title]="t.chatInterface.exportChat">
                <i class="fa fa-download"></i>
            </button>
            <button class="btn-icon danger" (click)="clearChat()" [title]="t.chatInterface.clearChat">
                <i class="fa fa-trash"></i>
            </button>
        </div>
    </div>

    <!-- Ê∂àÊÅØÂàóË°®ÂåÖË£ÖÂô® (Áî®‰∫éÊªöÂä®ÊåâÈíÆÂÆö‰Ωç) -->
    <div class="chat-content-wrapper">
        <!-- Ê∂àÊÅØÂàóË°® -->
        <div class="ai-chat-container" #chatContainer (scroll)="onScroll($event)">
            <div class="messages-wrapper">
                <!-- Ê∂àÊÅØÂàÜÁªÑ -->
                <ng-container *ngFor="let message of messages; let i = index">
                    <!-- Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊòæÁ§∫Êó•ÊúüÂàÜÈöîÁ∫ø -->
                    <div *ngIf="i === 0 || !isSameDay(message.timestamp, messages[i-1].timestamp)"
                        class="date-separator">
                        <span class="date-text">
                            {{ isToday(message.timestamp) ? t.common.today : message.timestamp.toLocaleDateString('zh-CN') }}
                        </span>
                    </div>

                    <!-- Ê∂àÊÅØÈ°π -->
                    <div class="message-item" [ngClass]="{
                             'user-message': message.role === 'user',
                             'assistant-message': message.role === 'assistant',
                             'system-message': message.role === 'system'
                         }">
                        <!-- Â§¥ÂÉè -->
                        <div class="message-avatar" *ngIf="showAvatars">
                            <div *ngIf="message.role === 'user'" class="avatar user">
                                <i class="fa fa-user"></i>
                            </div>
                            <div *ngIf="message.role === 'assistant'" class="avatar assistant">
                                <i class="fa fa-robot"></i>
                            </div>
                            <div *ngIf="message.role === 'system'" class="avatar system">
                                <i class="fa fa-info-circle"></i>
                            </div>
                        </div>

                        <!-- Ê∂àÊÅØÂÜÖÂÆπ -->
                        <div class="message-content">
                            <div class="message-bubble">
                                <!-- Áî®Êà∑Ê∂àÊÅØ -->
                                <div *ngIf="message.role === 'user'" class="message-text">
                                    {{ message.content }}
                                </div>

                                <!-- AIÊ∂àÊÅØ - ÊîØÊåÅ uiBlocks ÁªìÊûÑÂåñÊ∏≤Êüì -->
                                <div *ngIf="message.role === 'assistant'" class="message-text ai-response">
                                    <!-- ÂÖºÂÆπÊóßÊï∞ÊçÆ -->
                                    <ng-container *ngIf="!message.uiBlocks || message.uiBlocks.length === 0">
                                        <pre>{{ message.content }}</pre>
                                    </ng-container>
                                    
                                    <!-- Êñ∞Êï∞ÊçÆÔºöuiBlocks -->
                                    <ng-container *ngIf="message.uiBlocks && message.uiBlocks.length > 0">
                                        <ng-container *ngFor="let block of message.uiBlocks">
                                            
                                            <!-- ÊñáÊú¨Âùó -->
                                            <div *ngIf="block.type === 'text'" class="text-block">
                                                <pre>{{ block.content }}</pre>
                                            </div>

                                            <!-- Â∑•ÂÖ∑Âùó -->
                                            <div *ngIf="block.type === 'tool'" 
                                                 class="tool-card"
                                                 [ngClass]="{
                                                     'tool-executing': block.status === 'executing',
                                                     'tool-success': block.status === 'success',
                                                     'tool-error': block.status === 'error'
                                                 }">
                                                <div class="tool-header">
                                                    <span class="tool-icon">
                                                        <ng-container [ngSwitch]="block.status">
                                                            <ng-container *ngSwitchCase="'executing'">üîß</ng-container>
                                                            <ng-container *ngSwitchCase="'success'">‚úÖ</ng-container>
                                                            <ng-container *ngSwitchCase="'error'">‚ùå</ng-container>
                                                            <ng-container *ngSwitchDefault>üîß</ng-container>
                                                        </ng-container>
                                                    </span>
                                                    <span class="tool-name">{{ block.name }}</span>
                                                    <span class="tool-status" *ngIf="block.status === 'executing'">ÊâßË°å‰∏≠...</span>
                                                    <span class="tool-duration" *ngIf="block.status !== 'executing' && block.duration">{{ block.duration }}ms</span>
                                                </div>
                                                <div *ngIf="block.output && block.output.content" class="tool-output">
                                                    <pre>{{ block.output.content }}</pre>
                                                    <span *ngIf="block.output.truncated" class="truncated-note">...(Â∑≤Êà™Êñ≠)</span>
                                                </div>
                                                <div *ngIf="block.status === 'error' && block.errorMessage" class="tool-error">
                                                    <pre>{{ block.errorMessage }}</pre>
                                                </div>
                                            </div>

                                            <!-- ÂàÜÈöîÁ∫øÂùó -->
                                            <div *ngIf="block.type === 'divider'" class="round-divider">
                                                --- Á¨¨ {{ block.round }} ËΩÆ ---
                                            </div>

                                            <!-- Áä∂ÊÄÅÂùó -->
                                            <div *ngIf="block.type === 'status'" class="agent-status">
                                                {{ block.icon }} {{ block.text }}<span *ngIf="block.rounds"> ({{ block.rounds }} ËΩÆ)</span>
                                            </div>
                                            
                                        </ng-container>
                                    </ng-container>
                                </div>

                                <!-- Á≥ªÁªüÊ∂àÊÅØ -->
                                <div *ngIf="message.role === 'system'" class="message-text system">
                                    <i class="fa fa-exclamation-triangle"></i>
                                    {{ message.content }}
                                </div>
                            </div>

                            <!-- Ê∂àÊÅØÊó∂Èó¥ -->
                            <div class="message-time" *ngIf="showTimestamps">
                                {{ formatTimestamp(message.timestamp) }}
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
                <div *ngIf="isLoading" class="loading-indicator">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span class="loading-text">{{ t.chatInterface.thinking }}</span>
                </div>
            </div>
        </div>

        <!-- ÊªöÂä®ÊåâÈíÆ (Âú®ÂÆπÂô®Â§ñÈÉ®‰ª•‰æøÂõ∫ÂÆöÂÆö‰Ωç) -->
        <button *ngIf="showScrollTop" class="scroll-btn scroll-top" (click)="scrollToTop()" title="ÊªöÂä®Âà∞È°∂ÈÉ®">
            <i class="fa fa-chevron-up"></i>
        </button>
        <button *ngIf="showScrollBottom" class="scroll-btn scroll-bottom" (click)="scrollToBottom()" title="ÊªöÂä®Âà∞Â∫ïÈÉ®">
            <i class="fa fa-chevron-down"></i>
        </button>
    </div>

    <!-- ËæìÂÖ•Âå∫Âüü -->
    <div class="ai-chat-input">
        <app-chat-input (send)="onSendMessage($event)" [disabled]="isLoading">
        </app-chat-input>
    </div>

    <!-- ÊèêÁ§∫‰ø°ÊÅØ -->
    <div class="chat-tips" *ngIf="messages.length === 1">
        <div class="tip-item">
            <i class="fa fa-lightbulb-o"></i>
            <span>{{ t.chatInterface.tipCommand }}</span>
        </div>
        <div class="tip-item">
            <i class="fa fa-keyboard-o"></i>
            <span>{{ t.chatInterface.tipShortcut }}</span>
        </div>
    </div>
</div>
